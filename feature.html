<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APX ULTRA PREMIUM | DATA SYNC</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <style>
        /* same style as before, no change needed */
        :root { --neon: #00ffcc; --gold: #ffcc00; --bg: #010409; --call: #00ff88; --put: #ff3366; }
        body { margin: 0; background: var(--bg); color: #f1f5f9; font-family: 'Rajdhani', sans-serif; background-image: radial-gradient(circle at center, #0d1117 0%, #010409 100%); }
        header { padding: 20px; text-align: center; border-bottom: 2px solid var(--neon); background: #000; box-shadow: 0 0 20px rgba(0,255,204,0.3); }
        .logo { font-family: 'Orbitron'; font-size: 22px; color: var(--neon); text-shadow: 0 0 10px var(--neon); letter-spacing: 3px; }
        .container { max-width: 480px; margin: 20px auto; padding: 15px; }
        .panel { background: rgba(13,17,23,0.9); border: 1px solid rgba(0,255,204,0.2); border-radius: 20px; padding: 20px; backdrop-filter: blur(10px); }
        label { display: block; font-size: 11px; color: var(--neon); margin: 10px 0 5px; text-transform: uppercase; letter-spacing: 1px; }
        .tabs { display: flex; gap: 8px; margin-bottom: 15px; }
        .tab { flex: 1; padding: 10px; border: 1px solid var(--neon); background: transparent; color: var(--neon); border-radius: 8px; cursor: pointer; font-size: 11px; font-weight: bold; }
        .tab.active { background: var(--neon); color: #000; }
        select, input { width: 100%; padding: 12px; background: #0d1117; border: 1px solid #30363d; border-radius: 10px; color: #fff; outline: none; box-sizing: border-box; font-family: 'Orbitron', sans-serif; font-size: 13px; }
        .main-btn { width: 100%; padding: 16px; background: var(--neon); color: #000; border: none; border-radius: 12px; font-family: 'Orbitron'; font-weight: bold; cursor: pointer; margin-top: 15px; transition: 0.3s; }
        .main-btn:hover { background: #00cca3; box-shadow: 0 0 20px var(--neon); }
        .tg-btn { width: 100%; padding: 12px; background: #0088cc; color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        #output { margin-top: 20px; background: rgba(0,0,0,0.6); border-radius: 15px; border: 1px dashed var(--neon); min-height: 50px; padding: 15px; font-size: 12px; }
        .sig-row { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); font-weight: bold; align-items: center; }
        .time { color: var(--gold); font-family: 'Orbitron'; font-size: 13px; }
        .pair-name { font-size: 14px; color: #fff; }
        .CALL { color: var(--call); text-shadow: 0 0 5px var(--call); }
        .PUT { color: var(--put); text-shadow: 0 0 5px var(--put); }
        footer { text-align: center; padding: 20px; font-size: 10px; color: #484f58; letter-spacing: 2px; }
    </style>
</head>
<body>

<header>
    <div class="logo">APX ULTRA PREMIUM</div>
    <div id="clock">UTC+6 | 00:00:00</div>
</header>

<div class="container">
    <div class="panel">
        <label>Market Class</label>
        <div class="tabs">
            <button class="tab active" onclick="setMkt('OTC', this)">OTC</button>
            <button class="tab" onclick="setMkt('STOCKS', this)">STOCKS</button>
            <button class="tab" onclick="setMkt('CRYPTO', this)">CRYPTO</button>
        </div>

        <label>Select Assets (Multi - Try EURUSD-OTC First!)</label>
        <select id="asset-list" multiple size="5"></select>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <div><label>Start Time</label><input type="time" id="s-time"></div>
            <div><label>End Time</label><input type="time" id="e-time"></div>
        </div>

        <button class="main-btn" onclick="fetchAndAnalyze()">‚ö° ANALYZE API DATA</button>
        <button class="tg-btn" onclick="sendToTG()">üì± FORWARD TO TELEGRAM</button>

        <div id="output"><div style="text-align:center; padding:30px; color:#475569;">Awaiting API Sync...</div></div>
    </div>
</div>

<footer>STABLE ENGINE V7.5 | REAL-TIME DATA ONLY</footer>

<script>
    const PROXIES = [
    "https://api.codetabs.com/v1/proxy?quest=",  // Put this first ‚Äì it's working now
    "https://corsproxy.io/?",
    "https://api.allorigins.win/raw?url=",
    "https://thingproxy.freeboard.io/fetch/"
];
    const API_TEMPLATE = "https://mrbeaxt.site/Qx/Qx.php?format=json&timeframe=M1&limit=1000";
    const TG_WEBHOOK = "https://signal.mkapi009.workers.dev/send";

    const PAIRS = {
        OTC: ["EURUSD_otc", "GBPUSD_otc", "USDINR_otc", "USDPKR_otc", "USDBDT_otc", "USDBRL_otc", "USDNGN_otc", "USDARS_otc", "USDMXN_otc"],
        STOCKS: ["MSFSTK_otc", "AXPSTK_otc", "PFESTK_otc", "INTSTK_otc", "FBSTK_otc"],
        CRYPTO: ["BTCUSD_otc", "ETHUSD_otc", "BNBUSD_otc"]
    };

    let SIGNALS = [];
    let ALL_CANDLES = {};
    let fetchErrors = [];

    // Clock
    setInterval(() => {
        let d = new Date(); d.setHours(d.getUTCHours() + 6);
        document.getElementById('clock').innerText = "UTC+6 | " + d.toLocaleTimeString('en-GB');
    }, 1000);

    window.onload = () => {
        let d = new Date(); d.setHours(d.getUTCHours() + 6);
        document.getElementById('s-time').value = d.toTimeString().slice(0, 5);
        let ed = new Date(d.getTime() + 60*60000);
        document.getElementById('e-time').value = ed.toTimeString().slice(0, 5);
        setMkt('OTC', document.querySelector('.tab'));
    };

    function setMkt(t, b) {
        const l = document.getElementById('asset-list'); l.innerHTML = "";
        document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
        b.classList.add('active');
        PAIRS[t].forEach(p => {
            let o = document.createElement('option'); o.value = p;
            o.innerText = p.replace("_otc", "-OTC").toUpperCase();
            l.add(o);
        });
    }

    async function tryFetchWithProxies(url) {
        for (let proxy of PROXIES) {
            try {
                const fullUrl = proxy + encodeURIComponent(url);
                const res = await fetch(fullUrl, { mode: 'cors', cache: 'no-cache' });
                if (res.ok) return await res.json();
            } catch (e) {
                console.warn(`Proxy ${proxy} failed:`, e);
            }
        }
        throw new Error("All proxies failed");
    }

    async function fetchAndAnalyze() {
        const assets = [...document.getElementById('asset-list').selectedOptions].map(o => o.value);
        const startTime = document.getElementById('s-time').value;
        const endTime = document.getElementById('e-time').value;
        const box = document.getElementById('output');

        if (assets.length === 0) return alert("Select at least one asset!");

        box.innerHTML = `<div style="text-align:center; padding:30px; color:var(--neon);">[ FETCHING ${assets.length} ASSETS... ]</div>`;
        SIGNALS = [];
        ALL_CANDLES = {};
        fetchErrors = [];

        for (let asset of assets) {
            try {
                const url = `\( {API_TEMPLATE}&pair= \){asset}`;
                const json = await tryFetchWithProxies(url);

                if (json && json.success && json.data && json.data.length > 0) {
                    const normalized = asset.toLowerCase().replace(/_otc$/, '');
                    const filtered = json.data.filter(c => 
                        c.pair && (c.pair.toLowerCase() === normalized + '_otc' || c.pair.toLowerCase().includes(normalized))
                    );

                    if (filtered.length >= 5) {  // Lowered to 5 for testing
                        ALL_CANDLES[asset] = filtered;
                        console.log(`OK ${asset}: ${filtered.length} candles`);
                    } else {
                        fetchErrors.push(`${asset}: Only ${filtered.length} candles after filter`);
                    }
                } else {
                    fetchErrors.push(`${asset}: Invalid response (no success/data)`);
                }
            } catch (err) {
                fetchErrors.push(`${asset}: Fetch failed - ${err.message}`);
                console.error(err);
            }
        }

        if (Object.keys(ALL_CANDLES).length === 0) {
            let errMsg = `<div style="color:red; padding:20px; text-align:center;">
                DATA ERROR: API / PROXY ISSUE<br><br>
                <small>Details:<br>${fetchErrors.join('<br>') || 'No fetch attempted'}</small><br>
                Try: EURUSD-OTC only, switch to WiFi, or check console.
            </div>`;
            box.innerHTML = errMsg;
            return;
        }

        generateSignals(assets, startTime, endTime);
        renderHTML();
    }

    // generateSignals and renderHTML same as before (no change needed, copy from previous if you want)

    function generateSignals(assets, start, end) {
        let now = new Date();
        let sDate = new Date(now.toDateString() + " " + start);
        let eDate = new Date(now.toDateString() + " " + end);
        if (eDate <= sDate) eDate.setDate(eDate.getDate() + 1);

        const durationMs = eDate.getTime() - sDate.getTime();
        const numSignals = Math.min(15, Math.max(10, Math.floor(durationMs / 60000 / 4) + 1));

        SIGNALS = [];

        for (let i = 0; i < numSignals; i++) {
            const asset = assets[i % assets.length];
            const candles = ALL_CANDLES[asset];
            if (!candles) continue;

            const last20 = candles.slice(0, 20);
            const greenCount = last20.filter(c => c.color === "green").length;
            const direction = greenCount >= 11 ? "CALL" : "PUT";

            const signalTimeMs = sDate.getTime() + (i * (durationMs / Math.max(1, numSignals - 1)));
            const signalDate = new Date(signalTimeMs);
            const signalTimeStr = signalDate.toTimeString().slice(0, 5);

            let displayPair = asset.replace("_otc", "-OTC").toUpperCase();

            SIGNALS.push({
                pair: displayPair,
                time: signalTimeStr,
                rawTime: signalTimeMs,
                dir: direction
            });
        }

        SIGNALS.sort((a, b) => a.rawTime - b.rawTime);
    }

    function renderHTML() {
        const box = document.getElementById('output');
        box.innerHTML = "";
        if (SIGNALS.length === 0) {
            box.innerHTML = `<div style="text-align:center; padding:30px; color:orange;">NO SIGNALS GENERATED - CHECK ERRORS ABOVE</div>`;
            return;
        }
        SIGNALS.forEach(s => {
            box.innerHTML += `
            <div class="sig-row">
                <span class="time">${s.time}</span>
                <span class="pair-name">${s.pair}</span>
                <span class="\( {s.dir}"> \){s.dir}</span>
            </div>`;
        });
    }

    async function sendToTG() {
        if(SIGNALS.length === 0) return alert("No signals!");
        let msg = `üëë *APX ULTRA PREMIUM* üëë\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüìä *DATA:* REAL-TIME\nüéØ *ACC:* 80%+\n‚è∞ UTC+6\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
        SIGNALS.forEach(s => {
            msg += `üîπ \`M1;\( {s.pair}; \){s.time};${s.dir}\` ${s.dir==='CALL'?'üü¢':'üî¥'}\n`;
        });
        msg += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüöÄ POWERED BY API`;
        try {
            await fetch(TG_WEBHOOK, { method: "POST", body: msg });
            alert("Sent!");
        } catch(e) { alert("TG failed"); }
    }
</script>
</body>
</html>
