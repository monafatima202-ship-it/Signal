<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>APX ULTRA PREMIUM</title>

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">

<style>
:root { --neon:#00ffcc; --bg:#010409; --call:#00ff88; --put:#ff3366; --gold:#ffcc00; }
body { margin:0; background:var(--bg); font-family:'Rajdhani'; color:white; }
header { padding:20px; text-align:center; border-bottom:2px solid var(--neon); background:black; box-shadow:0 0 15px var(--neon); }
.logo { font-family:'Orbitron'; color:var(--neon); font-size:24px; }
.container { max-width:480px; margin:20px auto; padding:15px; }
.panel { background:#0d1117; border:1px solid rgba(0,255,204,0.3); border-radius:20px; padding:20px; }
.tabs { display:flex; gap:6px; margin-bottom:15px; }
.tab { flex:1; padding:10px; border:1px solid var(--neon); background:transparent; color:var(--neon); border-radius:8px; cursor:pointer; font-size:11px; font-weight:bold; }
.tab.active { background:var(--neon); color:black; }
select, input { width:100%; padding:12px; background:#020617; color:white; border:1px solid #30363d; border-radius:10px; margin-bottom:15px; }
.main-btn { width:100%; padding:16px; background:var(--neon); color:black; border:none; border-radius:12px; font-family:'Orbitron'; font-weight:bold; cursor:pointer; }
.tg-btn { width:100%; padding:12px; background:#0088cc; color:white; border:none; border-radius:12px; cursor:pointer; margin-top:10px; }
#output { margin-top:20px; padding:10px; border:1px dashed var(--neon); border-radius:15px; min-height:200px; }
.loading { text-align:center; padding:25px; font-family:'Orbitron'; color:var(--neon); animation:pulse 1s infinite alternate; }
@keyframes pulse { from{opacity:0.4;} to{opacity:1;} }
.sig-row { display:flex; justify-content:space-between; padding:12px 8px; border-bottom:1px solid rgba(255,255,255,0.08); font-size:14px; }
.time { color:var(--gold); font-family:'Orbitron'; min-width:60px; }
.pair { min-width:100px; }
.dir { font-weight:bold; }
.CALL { color:var(--call); }
.PUT { color:var(--put); }
</style>
</head>

<body>

<header>
<div class="logo">APX NEURAL ENGINE</div>
<div id="clock">UTC+6</div>
</header>

<div class="container">
<div class="panel">

<div class="tabs">
<button class="tab active" onclick="setMarket('OTC',this)">OTC</button>
<button class="tab" onclick="setMarket('STOCK',this)">STOCK</button>
<button class="tab" onclick="setMarket('CRYPTO',this)">CRYPTO</button>
</div>

<select id="pairs" multiple size="10"></select>
<input type="time" id="start" value="20:00">
<input type="time" id="end" value="23:59">

<button class="main-btn" onclick="startEngine()">GENERATE SMART SIGNALS</button>
<button class="tg-btn" onclick="pushTG()">SEND TELEGRAM</button>

<div id="output">Ready Mona bhai â€“ Ab naya API use kar rahe hain (serv00.net wala). Pairs select kar, Generate daba!</div>

</div>
</div>

<script>

// NAYA API â€“ direct use (tera serv00.net wala, proxy nahi chahiye ab)
function buildAPI(pair){
  return `https://milongazi197.serv00.net/otc.php?pair=${pair}&tf=M1&limit=500`;
  // Agar CORS error aaye to proxy add kar sakte hain: return "https://api.codetabs.com/v1/proxy?quest=" + encodeURIComponent(`https://milongazi197.serv00.net/otc.php?pair=${pair}&tf=M1&limit=500`);
}

const TG = "https://signal.mkapi009.workers.dev/send"; // yeh same rakha, agar tera hai to change kar lena
const TARGET = 15;

const LIST = {
  OTC: ["USDINR-otc","USDPKR-otc","USDBDT-otc","USDCOP-otc","USDARS-otc","USDMXN-otc","USDZAR-otc","BRLUSD-otc","USDNGN-otc","USDTRY-otc","USDDZD-otc","USDEGP-otc"],
  STOCK: ["MSFSTK-OTC","AXPSTK-OTC"],
  CRYPTO: ["BTCUSD-otc","ETHUSD-otc"]
};

let SIGNALS = [];

// CLOCK
setInterval(() => {
  let d = new Date();
  d.setHours(d.getUTCHours() + 6);
  clock.innerText = "UTC+6 | " + d.toLocaleTimeString('en-US', {hour12:false});
}, 1000);

// TABS
function setMarket(t, b){
  pairs.innerHTML = "";
  document.querySelectorAll(".tab").forEach(x => x.classList.remove("active"));
  b.classList.add("active");
  LIST[t].forEach(p => {
    let o = document.createElement("option");
    o.value = p;
    o.text = p.toUpperCase().replace('-OTC','');
    pairs.add(o);
  });
}
setMarket("OTC", document.querySelector(".tab"));

// ANALYZE
function analyze(candles) {
  if (candles.length < 5) {
    console.log("Too few candles");
    return "HOLD";
  }

  let recent = candles.slice(-6);
  let up = 0, down = 0;

  for (let i = 1; i < recent.length; i++) {
    if (recent[i].close > recent[i-1].close) up++;
    else if (recent[i].close < recent[i-1].close) down++;
  }

  let last = recent[recent.length-1];
  let isBull = last.close > last.open;

  let dir = (up >= down || isBull) ? "CALL" : "PUT";

  console.log(`Pair analyzed | Up: ${up} Down: ${down} | Last bull? ${isBull} â†’ ${dir}`);

  return dir;
}

// ENGINE
async function startEngine() {
  SIGNALS = [];
  let selected = [...pairs.selectedOptions].map(o => o.value);
  if (!selected.length) return alert("Koi pair select kar!");

  output.innerHTML = `<div class="loading">SCANNING NEW API... wait kar Jason/Mona ðŸ˜„</div>`;

  for (let asset of selected) {
    let apiURL = buildAPI(asset);
    try {
      let res = await fetch(apiURL);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      let json = await res.json();
      let candles = json?.data || [];  // Naya API mein direct "data" array hai (count/pair top level)

      console.log(`${asset}: ${candles.length} candles fetched from new API!`);

      if (candles.length < 5) continue;

      let direction = analyze(candles);
      distribute(asset, direction);
    } catch (e) {
      console.error(`Error ${asset}: ${e.message}`);
    }
  }

  SIGNALS.sort((a,b) => a.raw - b.raw);
  displaySignals();
}

// DISTRIBUTE
function distribute(pair, dir) {
  let s = start.value || "20:00";
  let e = end.value || "23:59";

  let now = new Date();
  let [sH, sM] = s.split(":").map(Number);
  let [eH, eM] = e.split(":").map(Number);

  let sD = new Date(now);
  sD.setHours(sH, sM, 0, 0);
  sD.setSeconds(0); sD.setMilliseconds(0);

  let eD = new Date(now);
  eD.setHours(eH, eM, 0, 0);
  eD.setSeconds(0); eD.setMilliseconds(0);

  if (eD <= sD) eD.setDate(eD.getDate() + 1);

  let totalMs = eD - sD;
  let gap = totalMs / TARGET;

  for (let i = 0; i < TARGET; i++) {
    let t = new Date(sD.getTime() + gap * i);
    SIGNALS.push({
      pair: pair.toUpperCase(),
      time: t.toTimeString().slice(0, 5),
      raw: t.getTime(),
      dir: dir
    });
  }
}

function displaySignals() {
  output.innerHTML = "";
  if (!SIGNALS.length) {
    output.innerHTML = "Signals nahi? Console khol (mobile pe Eruda add kar ya PC se inspect) aur error bata. Naya API test kar raha hai!";
    return;
  }

  SIGNALS.forEach(s => {
    output.innerHTML += `
<div class="sig-row">
  <span class="time">${s.time}</span>
  <span class="pair">${s.pair}</span>
  <span class="dir \( {s.dir}"> \){s.dir}</span>
</div>`;
  });
}

async function pushTG() {
  if (!SIGNALS.length) return alert("Generate pehle kar!");

  let msg = `âœ¦ APX SIGNALS âœ¦\nUTC+6 | 1 Min Expiry\nNew API (serv00)\n\n`;

  SIGNALS.forEach(s => {
    msg += `âŸ¡ ${s.pair} @ ${s.time} â†’ ${s.dir}\n`;
  });

  msg += `\nTrade smart!`;

  try {
    await fetch(TG, {method:"POST", body:msg});
    alert("Telegram pe bhej diya!");
  } catch(e) {
    alert("TG fail");
  }
}

</script>
</body>
</html>
