<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>APX ULTRA PREMIUM</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
<style>
:root { --neon:#00ffea; --dark:#0a0e17; --panel:#111827; --call:#00ff88; --put:#ff3366; --gold:#ffd700; }
body { background:var(--dark); color:white; font-family:'Rajdhani'; margin:0; }
header { padding:20px; text-align:center; border-bottom:2px solid var(--neon); background:black; box-shadow:0 0 15px var(--neon); }
.logo { font-family:'Orbitron'; color:var(--neon); font-size:22px; letter-spacing:3px; }
.container { max-width:480px; margin:20px auto; padding:10px; }
.panel { background:var(--panel); border:1px solid rgba(0,255,234,0.2); border-radius:16px; padding:20px; }
.tabs { display:flex; gap:8px; margin-bottom:15px; }
.tab { flex:1; padding:10px; border:1px solid var(--neon); background:transparent; color:var(--neon); border-radius:8px; cursor:pointer; font-weight:bold; }
.tab.active { background:var(--neon); color:black; }
select, input { width:100%; padding:12px; background:#0f1624; color:white; border:1px solid #334155; border-radius:10px; margin-bottom:12px; }
.main-btn, .tg-btn { width:100%; padding:16px; border-radius:12px; border:none; font-family:'Orbitron'; font-weight:bold; cursor:pointer; margin-bottom:10px; }
.main-btn { background:var(--neon); color:black; }
.tg-btn { background:#0088cc; color:white; }
#output { margin-top:20px; border:1px dashed var(--neon); border-radius:12px; background:rgba(0,255,234,0.03); min-height:100px; padding:10px; }
.sig-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); }
.CALL { color:var(--call); font-weight:bold; }
.PUT { color:var(--put); font-weight:bold; }
.time { color:var(--gold); }
</style>
</head>
<body>

<header>
    <div class="logo">APX ULTRA PREMIUM</div>
    <div id="clock">UTC+6</div>
</header>

<div class="container">
    <div class="panel">
        <div class="tabs">
            <button class="tab active" onclick="setMarket('OTC',this)">OTC</button>
            <button class="tab" onclick="setMarket('STOCK',this)">STOCK</button>
            <button class="tab" onclick="setMarket('CRYPTO',this)">CRYPTO</button>
        </div>
        <select id="pairs" multiple></select>
        <input type="time" id="start" value="10:00">
        <input type="time" id="end" value="14:00">
        <button class="main-btn" onclick="startEngine()">GENERATE SIGNALS</button>
        <button class="tg-btn" onclick="pushTG()">SEND TO TELEGRAM</button>
        <div id="output">Ready...</div>
    </div>
</div>

<script>
const API = "https://apx.mkapi009.workers.dev?pair=";
const TG  = "https://signal.mkapi009.workers.dev/send";
let SIGNALS = [];

const LIST = {
    OTC: ["USDINR-otc","USDPKR-otc","USDBDT-otc","USDCOP-otc","USDARS-otc","USDMXN-otc"],
    STOCK: ["MSFSTK-OTC","AXPSTK-OTC"],
    CRYPTO: ["BTCUSD-otc","ETHUSD-otc"]
};

setInterval(() => {
    let d = new Date();
    d.setHours(d.getUTCHours() + 6);
    document.getElementById('clock').innerText = "UTC+6 | " + d.toLocaleTimeString('en-GB');
}, 1000);

function setMarket(t, btn){
    document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const sel = document.getElementById('pairs');
    sel.innerHTML = '';
    LIST[t].forEach(p => {
        let opt = document.createElement('option');
        opt.value = p; opt.textContent = p.replace('-otc','').toUpperCase();
        sel.appendChild(opt);
    });
}
setMarket('OTC', document.querySelector('.tab'));

// Fixed Logic: Balanced CALL/PUT based on 20-candle momentum
function analyzeTrend(candles) {
    if (candles.length < 10) return Math.random() > 0.5 ? "CALL" : "PUT";
    
    let upScore = 0;
    let downScore = 0;
    const last15 = candles.slice(-15);

    last15.forEach((c, i) => {
        if (i === 0) return;
        if (c.close > last15[i-1].close) upScore++;
        else downScore++;
    });

    // Probability factor
    if (upScore > downScore) return "CALL";
    if (downScore > upScore) return "PUT";
    return Math.random() > 0.5 ? "CALL" : "PUT";
}

async function startEngine() {
    SIGNALS = [];
    const selected = [...document.getElementById('pairs').selectedOptions].map(o => o.value);
    if (!selected.length) return alert("Pair select karo!");

    document.getElementById('output').innerHTML = "Scanning...";

    for (const pair of selected) {
        try {
            const res = await fetch(API + pair);
            const json = await res.json();
            const candles = json?.data || [];
            
            // Generate multiple signals for this pair
            for(let i=0; i<3; i++) {
                const direction = analyzeTrend(candles);
                generateTimedSignal(pair, direction, i);
            }
        } catch(e) { console.error(e); }
    }
    SIGNALS.sort((a,b) => a.raw - b.raw);
    display();
}

function generateTimedSignal(pair, dir, offset) {
    const s = document.getElementById('start').value;
    const e = document.getElementById('end').value;
    const now = new Date();
    let sD = new Date(now.toDateString() + " " + s);
    let eD = new Date(now.toDateString() + " " + e);
    if (eD <= sD) eD.setDate(eD.getDate() + 1);

    // Distribute randomly within range
    const targetTime = new Date(sD.getTime() + Math.random() * (eD - sD));
    
    SIGNALS.push({
        pair: pair.toUpperCase().replace('-OTC','').replace('-otc',''),
        time: targetTime.toTimeString().slice(0,5),
        raw: targetTime.getTime(),
        dir: dir
    });
}

function display() {
    const out = document.getElementById('output');
    out.innerHTML = '';
    SIGNALS.forEach(s => {
        out.innerHTML += `<div class="sig-row"><span class="time">${s.time}</span><span>${s.pair}</span><span class="${s.dir}">${s.dir}</span></div>`;
    });
}

async function pushTG() {
    if (!SIGNALS.length) return alert("Generate signals first");

    let msg = `✦═╡ APX ULTRA SIGNALS ╞═✦\n\n`;
    msg += `UTC+6 Timezone | 1 Min Expiry\n`;
    msg += `━━━━━━━━━━━━━━━━━━\n`;

    SIGNALS.forEach(s => {
        // Alignment logic using padding for fixed width look
        let timePart = `✦ ${s.time}`;
        let pairPart = `${s.pair}`.padEnd(10);
        msg += ` ${timePart} | ${pairPart} | ${s.dir}\n`;
    });

    msg += `━━━━━━━━━━━━━━━━━━\n`;
    msg += `RULES: 1-Step Martingale | Avoid News\n`;
    msg += `Powered by APX Premium`;

    try {
        await fetch(TG, { method: "POST", body: msg });
        alert("Sent to Telegram!");
    } catch(e) { alert("Failed!"); }
}
</script>
</body>
</html>
