<script>

// ===== CONFIG =====
const API="https://candle.mkapi009.workers.dev/?pair=";
const TG="https://signal.mkapi009.workers.dev/send";

const TARGET=18;

// ===== PAIRS =====
const LIST={
OTC:["USDPKR_otc","USDBDT_otc","USDCOP_otc","USDNGN_otc","USDINR_otc","USDBRL_otc"],
STOCK:["MSFT_otc","AXP_otc","PFE_otc"],
CRYPTO:["BTCUSD_otc","ETHUSD_otc"]
};

let SIGNALS=[];

// ===== CLOCK =====
setInterval(()=>{
let d=new Date();
d.setHours(d.getUTCHours()+6);
clock.innerText="UTC+6 | "+d.toLocaleTimeString();
},1000);

// ===== MARKET SWITCH =====
function setMarket(t,b){

pairs.innerHTML="";
document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
b.classList.add("active");

LIST[t].forEach(p=>{
let o=document.createElement("option");
o.value=p;
o.text=p.replace("_otc","-OTC").toUpperCase();
pairs.add(o);
});

}
setMarket("OTC",document.querySelector(".tab"));


// ===== SMART CANDLE ANALYZER =====
function analyzeCandles(c){

let bull=0;
let bear=0;
let strong=0;

// last 10 candles scan
for(let i=0;i<10;i++){

let body=Math.abs(c[i].close-c[i].open);
let range=Math.abs(c[i].high-c[i].low);

if(range===0) continue;

let power=body/range;

// strong candle
if(power>0.55) strong++;

if(c[i].close>c[i].open) bull++;
else bear++;

}

// direction
let dir=bull>bear?"CALL":"PUT";

// confidence score
let score=(strong/10)+(Math.max(bull,bear)/10);

return {dir,score};

}


// ===== ENGINE =====
async function startEngine(){

SIGNALS=[];

let selected=[...pairs.selectedOptions].map(o=>o.value);

if(selected.length===0){
alert("Select pairs");
return;
}

output.innerHTML=`<div class="loading">⧗ SCANNING LIVE MARKET...</div>`;

for(let asset of selected){

if(SIGNALS.length>=TARGET) break;

await loadPair(asset);

}

SIGNALS.sort((a,b)=>a.raw-b.raw);

displaySignals();

}


// ===== LOAD PAIR =====
async function loadPair(asset){

try{

let pairAPI=asset.replace("_otc","-OTC");

let res=await fetch(API+pairAPI+"&count=150");
if(!res.ok) return;

let json=await res.json();
let candles=json?.candles;
if(!candles || candles.length<20) return;


// ===== SMART ANALYSIS =====
let smart=analyzeCandles(candles);

// reject weak signals
if(smart.score<0.6) return;


// ===== USER TIME RANGE =====
let s=start.value||"00:00";
let e=end.value||"23:59";

let now=new Date();
let sD=new Date(now.toDateString()+" "+s);
let eD=new Date(now.toDateString()+" "+e);
if(eD<=sD) eD.setDate(eD.getDate()+1);


// ===== GENERATE MULTIPLE TIMES =====
for(let i=0;i<4;i++){

let t=new Date(sD.getTime()+Math.random()*(eD-sD));

SIGNALS.push({
pair:pairAPI,
time:t.toTimeString().slice(0,5),
raw:t.getTime(),
dir:smart.dir,
power:smart.score
});

if(SIGNALS.length>=TARGET) break;

}

}catch(e){}

}


// ===== DISPLAY =====
function displaySignals(){

output.innerHTML="";

if(SIGNALS.length===0){
output.innerHTML="No Smart Signals Found";
return;
}

SIGNALS.forEach(s=>{
output.innerHTML+=`
<div class="sig-row">
<span class="time">${s.time}</span>
<span>${s.pair}</span>
<span class="${s.dir}">${s.dir}</span>
</div>`;
});

}


// ===== TELEGRAM =====
async function pushTG(){

if(SIGNALS.length===0){
alert("Generate First");
return;
}

// fake loading telegram
await fetch(TG,{
method:"POST",
body:`✦ APX ENGINE ✦

⧗ SCANNING MARKET DATA
▓▓▓░░░░░ 40%`
});

await new Promise(r=>setTimeout(r,2000));


// final message
let msg=`✦═╡ APX SIGNAL FEED ╞═✦

UTC+6 Timezone
Expiry: 1 Minute
Money Management: 1 Step MTG

`;

SIGNALS.forEach(s=>{
msg+=`⟡ ${s.pair} │ ${s.time} │ ${s.dir}\n`;
});

msg+=`

══════════════════
TRADING RULES
══════════════════
Trade only at signal time
Use 1 Step Martingale only
Avoid high impact news
Stop after 2 losses

Powered by APX Elite Premium`;

await fetch(TG,{method:"POST",body:msg});

alert("Signals Sent To Telegram");

}

</script>
