<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>APX SMART ULTRA</title>
<style>
body{background:#0d1117;color:white;font-family:sans-serif;text-align:center;padding:20px}
button{padding:12px 20px;margin:10px;font-weight:bold}
select,input{padding:10px;margin:5px}
.sig{margin:5px;padding:8px;border-bottom:1px solid #333}
.call{color:#00ff88;font-weight:bold}
.put{color:#ff3366;font-weight:bold}
</style>
</head>
<body>

<h2>APX SMART ULTRA</h2>

<select id="pair">
<option value="USDINR-otc">USDINR-otc</option>
<option value="USDPKR-otc">USDPKR-otc</option>
<option value="USDZAR-otc">USDZAR-otc</option>
<option value="BTCUSD-otc">BTCUSD-otc</option>
</select>

<br>

Start Time: <input type="time" id="start" value="00:30">
End Time: <input type="time" id="end" value="00:45">

<br>

<button onclick="generate()">GENERATE SMART SIGNALS</button>

<div id="output"></div>

<script>

const API = "https://apx.mkapi009.workers.dev?pair=";

async function generate(){

    const pair = document.getElementById("pair").value;
    const output = document.getElementById("output");
    output.innerHTML = "Reading Market Structure...";

    try{
        const res = await fetch(API + pair);
        const data = await res.json();

        let candles = data?.data || [];

        if(candles.length < 50){
            output.innerHTML = "Not enough data";
            return;
        }

        // IMPORTANT: API newest first hoti hai — reverse karo
        candles = candles.reverse();

        const baseDirection = smartLogic(candles);

        createTimedSignals(pair, candles, baseDirection);

    }catch(e){
        output.innerHTML = "API Fetch Failed";
        console.log(e);
    }
}



function smartLogic(c){

    let trendScore = 0;
    let momentumScore = 0;
    let volumeScore = 0;

    // 20 candle trend
    for(let i=c.length-20;i<c.length;i++){
        if(c[i].close > c[i].open) trendScore++;
        else trendScore--;
    }

    // last 3 momentum
    for(let i=c.length-3;i<c.length;i++){
        if(c[i].close > c[i-1].close) momentumScore++;
        else momentumScore--;
    }

    // volume bias (last candle)
    let last = c[c.length-1];
    if(last.volume > 10){
        if(last.close > last.open) volumeScore += 1;
        else volumeScore -= 1;
    }

    let total = trendScore + momentumScore + volumeScore;

    if(total > 2) return "CALL";
    if(total < -2) return "PUT";

    // SIDEWAYS CONDITION → alternate logic
    return last.close > c[c.length-2].close ? "CALL" : "PUT";
}



function createTimedSignals(pair, candles, base){

    const output = document.getElementById("output");
    output.innerHTML = "";

    let start = document.getElementById("start").value;
    let end = document.getElementById("end").value;

    let now = new Date();
    let [sH,sM] = start.split(":").map(Number);
    let [eH,eM] = end.split(":").map(Number);

    let sTime = new Date(now);
    sTime.setHours(sH,sM,0);

    let eTime = new Date(now);
    eTime.setHours(eH,eM,0);

    let current = new Date(sTime);

    let flip = false;

    while(current <= eTime){

        let timeStr = current.toTimeString().slice(0,5);

        // alternate logic if weak trend
        let dir = base;

        if(Math.random() > 0.6){
            dir = flip ? "CALL" : "PUT";
            flip = !flip;
        }

        output.innerHTML += `
        <div class="sig">
            ${timeStr} | ${pair} |
            <span class="${dir==='CALL'?'call':'put'}">${dir}</span>
        </div>`;

        current.setMinutes(current.getMinutes()+1);
    }
}

</script>

</body>
</html>
