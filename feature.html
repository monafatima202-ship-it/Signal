<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>APX ULTRA PREMIUM - PERFECT FIXED</title>

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">

<style>
:root { --neon:#00ffcc; --bg:#010409; --call:#00ff88; --put:#ff3366; --gold:#ffcc00; }
body { margin:0; background:var(--bg); font-family:'Rajdhani'; color:white; }
header { padding:20px; text-align:center; border-bottom:2px solid var(--neon); background:black; box-shadow:0 0 15px var(--neon); }
.logo { font-family:'Orbitron'; color:var(--neon); font-size:24px; text-shadow:0 0 15px var(--neon); }
.container { max-width:500px; margin:20px auto; padding:15px; }
.panel { background:#0d1117; border:1px solid rgba(0,255,204,0.4); border-radius:20px; padding:25px; box-shadow:0 0 20px rgba(0,255,204,0.2); }
.tabs { display:flex; gap:8px; margin-bottom:20px; }
.tab { flex:1; padding:12px; border:1px solid var(--neon); background:transparent; color:var(--neon); border-radius:10px; cursor:pointer; font-size:13px; font-weight:bold; transition:0.3s; }
.tab.active { background:var(--neon); color:black; }
select, input[type="time"] { width:100%; padding:14px; background:#020617; color:white; border:1px solid #30363d; border-radius:12px; margin-bottom:15px; font-size:14px; }
.main-btn { width:100%; padding:18px; background:var(--neon); color:black; border:none; border-radius:12px; font-family:'Orbitron'; font-size:18px; font-weight:bold; cursor:pointer; margin:10px 0; }
.tg-btn { width:100%; padding:14px; background:#0088cc; color:white; border:none; border-radius:12px; cursor:pointer; font-size:16px; }
#output { margin-top:25px; padding:15px; border:1px dashed var(--neon); border-radius:15px; background:rgba(0,0,0,0.4); max-height:500px; overflow-y:auto; font-size:14px; }
.sig-row { display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid rgba(255,255,255,0.08); }
.time { color:var(--gold); font-family:'Orbitron'; min-width:60px; }
.pair { min-width:120px; }
.dir { font-weight:bold; min-width:80px; text-align:right; }
.prob { color:#aaa; font-size:12px; }
</style>
</head>

<body>

<header>
<div class="logo">APX NEURAL ENGINE PRO</div>
<div id="clock">UTC+6 | 00:00:00</div>
</header>

<div class="container">
<div class="panel">

<div class="tabs">
<button class="tab active" onclick="setMarket('OTC',this)">OTC</button>
<button class="tab" onclick="setMarket('STOCK',this)">STOCK</button>
<button class="tab" onclick="setMarket('CRYPTO',this)">CRYPTO</button>
</div>

<select id="pairs" multiple size="8"></select>

<input type="time" id="start" placeholder="Start (optional)">
<input type="time" id="end" placeholder="End (optional)">

<button class="main-btn" onclick="startEngine()">âš¡ GENERATE SIGNALS (CALL & PUT)</button>
<button class="tg-btn" onclick="pushTG()">ðŸ“© PUSH TO TELEGRAM</button>

<div id="output">Awaiting Neural Sync... Select pairs & Generate</div>
<div id="status">Standby Mode</div>

</div>
</div>

<script>

// CONFIG
const API = "https://candle.mkapi009.workers.dev/?pair=";
const TG = "https://signal.mkapi009.workers.dev/send";

const TARGET = 60;       // Max signals to generate
const MIN_ACC = 0.60;    // Show 60%+ only (adjust if needed)

// PAIRS
const LIST = {
  OTC: ["USDNGN_otc","USDARS_otc","USDEGP_otc","USDBDT_otc","USDCOP_otc","USDPKR_otc","USDINR_otc","USDBRL_otc","USDMXN_otc"],
  STOCK: ["MSFT_otc","AXP_otc","PFE_otc","INTEL_otc"],
  CRYPTO: ["BTCUSD_otc","ETHUSD_otc","BNBUSD_otc"]
};

let SIGNALS = [];

// CLOCK (UTC+6 for PKT)
setInterval(() => {
  let d = new Date();
  d.setHours(d.getUTCHours() + 6);
  document.getElementById("clock").innerText = "UTC+6 | " + d.toLocaleTimeString();
}, 1000);

// Set market tabs
function setMarket(t, b) {
  let pairs = document.getElementById("pairs");
  pairs.innerHTML = "";
  document.querySelectorAll(".tab").forEach(x => x.classList.remove("active"));
  b.classList.add("active");

  LIST[t].forEach(p => {
    let o = document.createElement("option");
    o.value = p;
    o.text = p.replace("_otc", "-OTC").toUpperCase();
    pairs.add(o);
  });
}
setMarket("OTC", document.querySelector(".tab"));

// ENGINE START
async function startEngine() {
  SIGNALS = [];

  let selected = [...document.getElementById("pairs").selectedOptions].map(o => o.value);
  if (selected.length === 0) {
    alert("Bhai, kam se kam 1 pair to select kar lo!");
    return;
  }

  document.getElementById("output").innerHTML = "API se data pull ho raha hai... thoda wait";

  for (let asset of selected) {
    if (SIGNALS.length >= TARGET) break;
    await loadPair(asset);
  }

  SIGNALS.sort((a, b) => b.raw - a.raw); // Latest first

  displaySignals();
}

// LOAD EACH PAIR
async function loadPair(asset) {
  try {
    let pairAPI = asset.replace("_otc", "-OTC");
    let res = await fetch(API + pairAPI + "&count=200");
    if (!res.ok) {
      console.log(`Fetch fail: ${pairAPI} - Status ${res.status}`);
      return;
    }

    let json = await res.json();
    let candles = json?.candles;
    if (!candles || !Array.isArray(candles)) {
      console.log(`No candles: ${pairAPI}`);
      return;
    }

    console.log(`Success: ${candles.length} candles from ${pairAPI}`);

    let now = Date.now();

    candles.forEach((c, idx) => {
      if (SIGNALS.length >= TARGET) return;

      let prob = c.win_prob || 0;
      if (prob < MIN_ACC) return;  // Skip low prob

      let dir = c.signal === "BUY" ? "CALL" : (c.signal === "SELL" ? "PUT" : "UNKNOWN");

      // Unique realistic time: current - idx minutes
      let candleDate = new Date(now - idx * 60 * 1000);
      let timeStr = candleDate.toTimeString().slice(0, 5);

      SIGNALS.push({
        pair: pairAPI.toUpperCase(),
        time: timeStr,
        raw: c.candle_time || (Date.now() - idx * 60000),
        dir: dir,
        prob: prob
      });
    });

  } catch (e) {
    console.error(`Error in ${asset}:`, e);
  }
}

// DISPLAY
function displaySignals() {
  let output = document.getElementById("output");
  output.innerHTML = "";

  if (SIGNALS.length === 0) {
    output.innerHTML = "Koi high accuracy signal nahi mila.<br>Console (F12) check karo details ke liye.";
    return;
  }

  output.innerHTML = `<strong>${SIGNALS.length} Signals Found (Min ${MIN_ACC*100}% Accuracy)</strong><br><br>`;

  SIGNALS.forEach(s => {
    output.innerHTML += `
<div class="sig-row">
  <span class="time">${s.time}</span>
  <span class="pair">${s.pair}</span>
  <span class="\( {s.dir}"> \){s.dir}</span>
  <span class="prob">(${ (s.prob * 100).toFixed(0) }%)</span>
</div>`;
  });
}

// TELEGRAM PUSH
async function pushTG() {
  if (SIGNALS.length === 0) {
    alert("Pehle signals generate karo bhai!");
    return;
  }

  let msg = `ðŸ”¥ APX ULTRA PREMIUM PRO ðŸ”¥\n\n`;

  SIGNALS.forEach(s => {
    msg += `M1; ${s.pair}; ${s.time}; \( {s.dir}  ( \){(s.prob*100).toFixed(0)}%)\n`;
  });

  msg += `\n====================\nUTC+6 Time\nExpiry: 1 Min\nMTG: 1 Step\nRisk Management Use Karo\n====================`;

  try {
    await fetch(TG, { method: "POST", body: msg });
    alert("Telegram pe push ho gaya!");
  } catch (e) {
    alert("Telegram fail ho gaya. Console check kar.");
    console.error(e);
  }
}

</script>

</body>
</html>
