<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>APX ULTRA ACCURACY ENGINE</title>

<style>
body{background:#0d1117;color:white;font-family:sans-serif;text-align:center;padding:20px}
select,button,input{padding:8px;margin:6px}
.sig{margin:5px;padding:8px;border-bottom:1px solid #333}
.call{color:#00ff88;font-weight:bold}
.put{color:#ff3366;font-weight:bold}
.loading{color:#00ffcc;font-weight:bold}
</style>
</head>
<body>

<h2>APX ULTRA ACCURACY ENGINE</h2>

<select id="pair">
<option value="USDINR-otc">USDINR-otc</option>
<option value="USDPKR-otc">USDPKR-otc</option>
<option value="USDBDT-otc">USDBDT-otc</option>
<option value="USDZAR-otc">USDZAR-otc</option>
<option value="BTCUSD-otc">BTCUSD-otc</option>
</select>

<br>

Signals Count:
<input type="number" id="count" value="15" min="5" max="20">

<br>

<button onclick="generate()">GENERATE SIGNALS</button>
<button onclick="sendTG()">SEND TELEGRAM</button>

<div id="output"></div>

<script>

const API = "https://apx.mkapi009.workers.dev?pair=";
const TG = "https://signal.mkapi009.workers.dev/send";

let FINAL_SIGNALS = [];

async function generate(){

    const pair = document.getElementById("pair").value;
    const count = parseInt(document.getElementById("count").value);
    const output = document.getElementById("output");

    output.innerHTML = "<div class='loading'>Analyzing market structure...</div>";
    FINAL_SIGNALS = [];

    try{

        const res = await fetch(API + pair);
        const data = await res.json();
        const candles = data?.data || data?.candles?.data || [];

        if(candles.length < 100){
            output.innerHTML = "Not enough candle data";
            return;
        }

        const signals = buildSignals(candles, pair, count);
        FINAL_SIGNALS = signals;

        display(signals);

    }catch(e){
        output.innerHTML = "API Fetch Failed";
        console.log(e);
    }
}

/* ========= CORE LOGIC ========= */

function EMA(data, period){
    let k = 2/(period+1);
    let ema = data[0].close;
    for(let i=1;i<data.length;i++){
        ema = data[i].close*k + ema*(1-k);
    }
    return ema;
}

function buildSignals(candles, pair, target){

    let signals = [];

    for(let i=50;i<candles.length-5;i++){

        let slice = candles.slice(0,i);

        let ema20 = EMA(slice.slice(-20),20);
        let ema50 = EMA(slice.slice(-50),50);

        let trend = ema20 > ema50 ? "CALL" : "PUT";

        let momentumScore = 0;
        let recent = slice.slice(-5);

        for(let j=1;j<recent.length;j++){
            if(recent[j].close > recent[j-1].close) momentumScore++;
            else momentumScore--;
        }

        if(trend==="CALL" && momentumScore>=2){
            signals.push(makeSignal(pair,trend,signals.length));
        }

        if(trend==="PUT" && momentumScore<=-2){
            signals.push(makeSignal(pair,trend,signals.length));
        }

        if(signals.length>=target) break;
    }

    return signals;
}

function makeSignal(pair, dir, index){
    let now = new Date();
    let t = new Date(now.getTime() + (index+1)*60000);
    return {
        time: t.toTimeString().slice(0,5),
        pair: pair,
        dir: dir
    }
}

function display(list){

    const output = document.getElementById("output");
    output.innerHTML = "";

    if(!list.length){
        output.innerHTML = "No High Probability Setup Found";
        return;
    }

    list.forEach(s=>{
        output.innerHTML += `
        <div class="sig">
            ${s.time} | ${s.pair} |
            <span class="${s.dir==='CALL'?'call':'put'}">${s.dir}</span>
        </div>`;
    });
}

async function sendTG(){

    if(!FINAL_SIGNALS.length){
        alert("Generate signals first");
        return;
    }

    let msg="✦═╡ APX ULTRA SIGNALS ╞═✦\n\n";

    FINAL_SIGNALS.forEach(s=>{
        msg+=`${s.time} | ${s.pair} | ${s.dir}\n`;
    });

    await fetch(TG,{method:"POST",body:msg});
    alert("Sent to Telegram");
}

</script>

</body>
</html>
